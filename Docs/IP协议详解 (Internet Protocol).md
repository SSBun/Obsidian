**IP协议**是 **TCP/IP 协议族**中最核心的协议之一，位于 **OSI 模型的网络层（Layer 3）**。它的主要职责是为数据包（在网络层被称为 **IP数据报** 或 **IP Datagram**）提供**寻址（Addressing）** 和 **路由（Routing）** 服务，确保数据能够跨越复杂的网络，从源主机正确传输到目标主机。

---

## 💻 核心特性

IP协议提供了 **不可靠的、无连接的** 数据传输服务，这意味着它具有以下特点：

* **无连接 (Connectionless)**：每个 IP 数据报都是独立发送的，它们可能沿着不同的路径到达目的地，不保证按序到达，也不维护任何会话状态。
* **不可靠 (Unreliable/Best-Effort)**：IP协议尽力而为地传输数据，但不提供任何保证。它不负责数据的丢失、损坏或重复检测。这些可靠性工作由上层协议（如 **TCP**）负责。
* **数据报封装 (Datagram Encapsulation)**：IP协议接收来自传输层的数据，并为其添加一个 **IP头部**，形成 IP 数据报。

---

## 🔢 IP地址结构 
![[Pasted image 20251209114759.png]]
IP地址是 IP 协议用于识别网络中设备的逻辑地址。目前主要使用两个版本：

### 1. IPv4

* **长度**: **32 位**。
* **格式**: **点分十进制**（例如：`192.168.1.1`）。
* **逻辑结构**:
    * **网络号 (Network ID)**：标识设备所属的网络。
    * **主机号 (Host ID)**：标识网络中的具体设备。
* **划分**: 使用 **子网掩码** 或 **CIDR (Classless Inter-Domain Routing)** 前缀来界定网络号和主机号的边界（例如：`192.168.1.0/24`，表示前 24 位是网络号）。

### 2. IPv6

* **长度**: **128 位**。
* **格式**: **冒号分隔的十六进制**（例如：`2001:db8:85a3::8a2e:370:7334`）。
* **逻辑结构**:
    * **网络前缀 (Network Prefix)**：通常是前 64 位，用于全球路由和子网划分。
    * **接口 ID (Interface ID)**：通常是后 64 位，用于唯一标识主机接口。
* **优势**: 极大的地址空间，内置的安全性 (IPsec) 和更好的移动性支持。

---

## 📦 IP 数据报头部结构 

![[Pasted image 20251209114655.png]]

IP 数据报头部包含路由和处理数据包所需的所有信息。对于 IPv4，头部通常有 **20 字节**（无选项字段时）。

| 字段 | 长度 | 描述 |
| :--- | :--- | :--- |
| **版本 (Version)** | 4 位 | IP 协议版本（4 或 6）。 |
| **头部长度 (IHL)** | 4 位 | IP 头部总长度（以 32 位字为单位）。 |
| **服务类型 (ToS)** | 8 位 | 用于区分服务质量（QoS）。 |
| **总长度 (Total Length)** | 16 位 | 整个 IP 数据报（头部 + 数据）的长度（以字节为单位）。 |
| **标识 (Identification)** | 16 位 | 用于分片时的识别，同一数据报的所有分片有相同的标识号。 |
| **标志 (Flags)** | 3 位 | 控制和指示分片，包括是否允许分片。 |
| **片偏移 (Fragment Offset)** | 13 位 | 指示该分片在原始数据报中的相对位置。 |
| **生存时间 (TTL)** | 8 位 | 数据报可以经过的最大路由器数。每经过一个路由器减 1，减到 0 则丢弃。 |
| **协议 (Protocol)** | 8 位 | 指示 IP 载荷（Payload）中封装的上层协议（如 TCP 为 6，UDP 为 17，ICMP 为 1）。 |
| **头部校验和** | 16 位 | 仅用于检查 IP 头部在传输过程中是否损坏。 |
| **源 IP 地址** | 32 位 | 发送数据报的主机的 IP 地址。 |
| **目标 IP 地址** | 32 位 | 接收数据报的主机的 IP 地址。 |

---

## 🔄 IP 协议工作流程示例：数据包路由

以下示例详述了一个数据包如何从一个网络的主机 $A$ 传输到另一个网络的主机 $B$。

### 场景设定

| 设备 | IP 地址 | 子网掩码 | 作用 |
| :--- | :--- | :--- | :--- |
| **主机 A** (源) | `192.168.1.10/24` | `255.255.255.0` | 位于 **网络 A**，要发送数据。 |
| **路由器 R1** (A 侧接口) | `192.168.1.1/24` | `255.255.255.0` | 主机 A 的**默认网关**。 |
| **路由器 R1** (B 侧接口) | `10.10.10.1/30` | `255.255.255.252` | 连接到中间链路。 |
| **路由器 R2** (R1 侧接口) | `10.10.10.2/30` | `255.255.255.252` | 连接到中间链路。 |
| **路由器 R2** (B 侧接口) | `172.16.0.1/24` | `255.255.255.0` | 主机 B 的默认网关。 |
| **主机 B** (目标) | `172.16.0.20/24` | `255.255.255.0` | 位于 **网络 B**，数据目标。 |

### 步骤详述

1.  **主机 A 封装数据报**
    * 应用层数据经过 TCP/UDP 传输层封装后，到达网络层。
    * 主机 A 创建一个 **IP 数据报**：
        * **源 IP**: `192.168.1.10`
        * **目标 IP**: `172.16.0.20`
2.  **主机 A 决定下一跳**
    * 主机 A 将目标 IP (`172.16.0.20`) 与自己的网络号 (`192.168.1.0/24`) 进行比较。它们**不在同一网络**。
    * 因此，主机 A 将数据包发送给其 **默认网关**，即路由器 **R1** (`192.168.1.1`)。
3.  **路由器 R1 路由决策**
    * R1 接收数据包，检查目标 IP (`172.16.0.20`)。
    * R1 查找其**路由表**。路由表中的一条记录指示：到达 `172.16.0.0/24` 网络的下一跳地址是 `10.10.10.2` (即 R2 的接口)。
    * R1 将数据包转发到连接 R2 的接口（IP 为 `10.10.10.1`）。
    * **注意**: 在转发过程中，IP 头部的 **源 IP** 和 **目标 IP** 保持不变，但 **TTL 值会减 1**，并且数据链路层（L2）的 MAC 地址会更新为 R2 接口的 MAC 地址。
4.  **路由器 R2 最终路由**
    * R2 接收数据包，再次检查目标 IP (`172.16.0.20`)。
    * R2 查找其路由表，发现 `172.16.0.20` 属于它直接连接的 **网络 B** (`172.16.0.0/24`)。
    * R2 通过 **ARP** 或其缓存确定主机 B 的 MAC 地址，并将数据包封装到数据链路层帧中，直接发送给主机 B。
5.  **主机 B 接收数据报**
    * 主机 B 接收到数据包，解封装 IP 头部，确认目标 IP 是自己。
    * IP 协议将数据报的数据载荷部分提取出来，根据 IP 头部中的 **"协议 (Protocol)" 字段**，将数据交给相应的上层协议（如 TCP 或 UDP）进行处理。
